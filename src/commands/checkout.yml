---
description: >
  Configure SSH aliases to route git traffic through the CircleCI tunnel.
  This allows you to use original git URLs (e.g., git@gitlab.example.com:org/repo.git)
  without rewriting them - SSH will automatically route through the tunnel and checkout
  code from a private repository via CircleCI tunnel.

parameters:
  tunnel-address:
    type: env_var_name
    description: >
      Environment variable name containing the tunnel address for the
      CircleCI tunnel
    default: "TUNNEL_ADDRESS"
  tunnel-port:
    type: env_var_name
    description: >
      Environment variable name containing the tunnel port for the
      CircleCI tunnel
    default: "TUNNEL_PORT"
  git-url:
    type: string
    description: "Git URL to the repository"
  original-hostname:
    type: string
    description: >
      The original git server hostname (e.g., gitlab.example.com).
      Git commands using this hostname will be routed through the tunnel.
  checkout-folder:
    type: string
    description: "Folder to checkout the repository into"
    default: "~/project"
  debug:
    type: boolean
    description: "Enable debug mode"
    default: false


steps:
  - run:
      environment:
        PARAM_TUNNEL_ADDRESS: << parameters.tunnel-address >>
        PARAM_TUNNEL_PORT: << parameters.tunnel-port >>
        ORIGINAL_HOSTNAME: << parameters.original-hostname >>
        DEBUG: << parameters.debug >>
      name: Configure SSH for tunnel
      command: <<include(scripts/ssh-aliases.sh)>>
  - run:
      environment:
        PARAM_TUNNEL_ADDRESS: << parameters.tunnel-address >>
        PARAM_TUNNEL_PORT: << parameters.tunnel-port >>
        GIT_URL: << parameters.git-url >>
        CHECKOUT_FOLDER: << parameters.checkout-folder >>
        DEBUG: << parameters.debug >>
      name: Clone repo
      command: <<include(scripts/checkout.sh)>>
